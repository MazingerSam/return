<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¼æ¥­é›²ç«¯ç›¸æ©Ÿç³»çµ±v1</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6f42c1;
            --success-color: #28a745;
            --bg-color: #f8f9fa;
        }

        body { 
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            text-align: center; 
            background-color: var(--bg-color); 
            margin: 0; 
            padding: 15px; 
        }

        .container { 
            max-width: 500px; 
            margin: auto; 
            background: white; 
            padding: 25px; 
            border-radius: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); 
        }

        h2 { color: #333; margin-top: 0; font-size: 22px; }

        /* è¼¸å…¥æ¡†æ¨£å¼ */
        .input-group { margin-bottom: 20px; text-align: left; }
        label { display: block; font-size: 14px; color: #666; margin-bottom: 8px; font-weight: 500; }
        input[type="text"] { 
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; 
            box-sizing: border-box; font-size: 16px; outline: none; transition: border 0.3s;
        }
        input[type="text"]:focus { border-color: var(--primary-color); }

        /* é è¦½å€ */
        .viewer-box { 
            position: relative;
            width: 100%; 
            aspect-ratio: 4/3;
            background: #000; 
            border-radius: 15px; 
            overflow: hidden; 
            margin-bottom: 20px;
        }
        #video, #preview { width: 100%; height: 100%; object-fit: cover; }
        #preview { display: none; }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-group { display: flex; flex-direction: column; gap: 12px; }
        button { 
            padding: 16px; font-size: 16px; font-weight: 600; border: none; 
            border-radius: 12px; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        #capture-btn { background-color: var(--primary-color); color: white; }
        #select-btn { background-color: var(--secondary-color); color: white; }
        #upload-btn { background-color: var(--success-color); color: white; display: none; }
        #retry-btn { background-color: #e9ecef; color: #495057; display: none; }
        
        button:active { transform: scale(0.97); opacity: 0.9; }
        button:disabled { background-color: #ccc !important; cursor: not-allowed; }

        /* ç‹€æ…‹æ–‡å­— */
        #status { 
            margin-top: 15px; font-size: 14px; color: var(--primary-color); 
            display: none; font-weight: 500; 
        }
    </style>
</head>
<body>

<div class="container">
    <h2>é›²ç«¯æ‹ç…§ä¸Šå‚³ç³»çµ±</h2>
    
    <div class="input-group">
        <label>å°ˆæ¡ˆåç¨± / æª”æ¡ˆæè¿°</label>
        <input type="text" id="filename-input" placeholder="è«‹è¼¸å…¥æª”å (ä¾‹å¦‚ï¼šé©—æ”¶ç…§ç‰‡)">
    </div>

    <div class="viewer-box">
        <video id="video" autoplay playsinline></video>
        <img id="preview" alt="ç…§ç‰‡é è¦½" />
    </div>
    
    <input type="file" id="file-input" accept="image/*" style="display: none;">
    <canvas id="canvas" style="display:none;"></canvas>

    <div class="btn-group">
        <button id="capture-btn">ğŸ“· ç«‹å³æ‹ç…§</button>
        <button id="select-btn">ğŸ–¼ï¸ å¾ç›¸ç°¿é¸æ“‡</button>
        <button id="upload-btn">ğŸš€ ç¢ºèªä¸¦ä¸Šå‚³</button>
        <button id="retry-btn">ğŸ”„ æ”¾æ£„é‡ä¾†</button>
    </div>
    
    <div id="status">â³ æ­£åœ¨è¾¨è­˜èº«åˆ†ä¸¦ä¸Šå‚³ä¸­...</div>
</div>

<script>
    const video = document.getElementById('video');
    const preview = document.getElementById('preview');
    const fileInput = document.getElementById('file-input');
    const fileNameInput = document.getElementById('filename-input');
    const captureBtn = document.getElementById('capture-btn');
    const selectBtn = document.getElementById('select-btn');
    const uploadBtn = document.getElementById('upload-btn');
    const retryBtn = document.getElementById('retry-btn');
    const statusDiv = document.getElementById('status');

    // ğŸ”´ è«‹åœ¨æ­¤æ›¿æ›ç‚ºä½ æœ€æ–°çš„ Google Apps Script éƒ¨ç½²ç¶²å€
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwusY8Wvw3yuHC86-Mtr5Vtuef0wukpd9GFPPtlP0-1V-X9CW0nmHG1F28wEE5sdMJJ/exec"; 

    // åˆå§‹åŒ–ï¼šé–‹å•Ÿå¾Œç½®ç›¸æ©Ÿ
    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment" }, 
                audio: false 
            });
            video.srcObject = stream;
        } catch (err) {
            console.error("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼Œè«‹ä½¿ç”¨ç›¸ç°¿åŠŸèƒ½:", err);
        }
    }

    // åŠŸèƒ½ï¼šé¡¯ç¤ºé è¦½åœ–
    function showPreview(dataUrl) {
        preview.src = dataUrl;
        video.style.display = 'none';
        preview.style.display = 'block';
        
        captureBtn.style.display = 'none';
        selectBtn.style.display = 'none';
        uploadBtn.style.display = 'block';
        retryBtn.style.display = 'block';
    }

    // 1. æ‹ç…§æŒ‰éˆ•
    captureBtn.onclick = () => {
        const canvas = document.getElementById('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        showPreview(canvas.toDataURL('image/jpeg', 0.8)); // å£“ç¸®ç‡ 0.8
    };

    // 2. ç›¸ç°¿é¸æ“‡
    selectBtn.onclick = () => fileInput.click();
    fileInput.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => showPreview(event.target.result);
        reader.readAsDataURL(file);
    };

    // 3. é‡è©¦æŒ‰éˆ•
    retryBtn.onclick = () => {
        video.style.display = 'block';
        preview.style.display = 'none';
        captureBtn.style.display = 'block';
        selectBtn.style.display = 'block';
        uploadBtn.style.display = 'none';
        retryBtn.style.display = 'none';
        fileInput.value = ""; 
    };

    // 4. ä¸Šå‚³æŒ‰éˆ• (æ ¸å¿ƒåŠŸèƒ½)
    uploadBtn.onclick = () => {
        const base64Data = preview.src.split(',')[1];
        const description = fileNameInput.value.trim() || "ç¾å ´ç…§ç‰‡";
        const dateStr = new Date().toLocaleString('zh-TW', { hour12: false }).replace(/\//g, '-');
        const finalFileName = `${description}_${dateStr}.jpg`;

        // UI ç‹€æ…‹é–å®š
        uploadBtn.disabled = true;
        retryBtn.disabled = true;
        statusDiv.style.display = 'block';

        fetch(SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify({
                image: base64Data,
                mimeType: "image/jpeg",
                fileName: finalFileName
            })
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === "success") {
                alert(`âœ… ä¸Šå‚³æˆåŠŸï¼\nè¨˜éŒ„å¸³è™Ÿï¼š${data.user}\næª”æ¡ˆå·²å­˜å…¥ Google Driveã€‚`);
                location.reload(); 
            } else {
                alert("âŒ ä¸Šå‚³å¤±æ•—: " + data.message);
                uploadBtn.disabled = false;
                retryBtn.disabled = false;
            }
        })
        .catch(err => {
            alert("âŒ é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¢ºèªç¶²è·¯æˆ–ç™»å…¥ç‹€æ…‹");
            uploadBtn.disabled = false;
            retryBtn.disabled = false;
        })
        .finally(() => {
            statusDiv.style.display = 'none';
        });
    };

    // é€²å…¥é é¢è‡ªå‹•å•Ÿå‹•ç›¸æ©Ÿ
    startCamera();
</script>

</body>
</html>

