<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¼æ¥­ç´šç”¢å“ç´€éŒ„ç³»çµ±</title>
    <style>
        :root { --main: #007bff; --success: #28a745; --bg: #f4f7f6; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .card { max-width: 480px; margin: auto; background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { font-size: 20px; color: #333; }
        .form-item { text-align: left; margin-bottom: 15px; }
        label { font-size: 14px; font-weight: 600; color: #444; }
        input, textarea { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .viewer { width: 100%; border-radius: 12px; background: #000; margin-bottom: 10px; overflow: hidden; aspect-ratio: 4/3; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .previews { display: flex; gap: 8px; margin: 10px 0; }
        .p-box { flex: 1; aspect-ratio: 1/1; background: #eee; border-radius: 6px; overflow: hidden; border: 1px solid #ddd; }
        .p-box img { width: 100%; height: 100%; object-fit: cover; }
        .btn-stack { display: flex; flex-direction: column; gap: 10px; }
        button { padding: 16px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        #cam-btn { background: var(--main); color: white; }
        #save-btn { background: var(--success); color: white; display: none; }
        #clear-btn { background: #6c757d; color: white; display: none; }
        button:active { transform: scale(0.98); }
        .status { color: var(--main); font-size: 14px; margin-top: 10px; display: none; font-weight: bold; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ“¸ é›²ç«¯é©—æ”¶ç®¡ç†ç³»çµ±</h2>
    
    <div class="form-item">
        <label>ç”¢å“åç¨± / ç·¨è™Ÿ</label>
        <input type="text" id="p-name" placeholder="è«‹è¼¸å…¥ç”¢å“åç¨±">
    </div>
    <div class="form-item">
        <label>æ•¸é‡ / å‚™è¨»</label>
        <textarea id="p-note" rows="2" placeholder="è«‹è¼¸å…¥ç›¸é—œèªªæ˜..."></textarea>
    </div>

    <div class="viewer"><video id="vid" autoplay playsinline></video></div>
    
    <div class="previews">
        <div class="p-box"></div><div class="p-box"></div><div class="p-box"></div>
    </div>

    <div class="btn-stack">
        <button id="cam-btn">ğŸ“· æ‹ç…§ / é¸å– (æœ€å¤š3å¼µ)</button>
        <button id="save-btn">ğŸš€ ç«‹å³ä¸Šå‚³ä¸¦ç´€éŒ„</button>
        <button id="clear-btn">ğŸ”„ å…¨éƒ¨æ¸…é™¤</button>
    </div>
    
    <div id="loading" class="status">â³ æ­£åœ¨è™•ç†åˆ†é¡å­˜æª”èˆ‡è©¦ç®—è¡¨...</div>
    <input type="file" id="files" accept="image/*" multiple style="display:none">
    <canvas id="canvas" style="display:none"></canvas>
</div>

<script>
    const vid = document.getElementById('vid');
    const pBoxes = document.querySelectorAll('.p-box');
    const fInput = document.getElementById('files');
    const camBtn = document.getElementById('cam-btn');
    const saveBtn = document.getElementById('save-btn');
    const clearBtn = document.getElementById('clear-btn');
    const loading = document.getElementById('loading');

    let queue = [];
    // ğŸ”´ è«‹ç¢ºä¿æ­¤è™•ç‚ºæœ€æ–°çš„éƒ¨ç½²ç¶²å€
    const API = "https://script.google.com/macros/s/AKfycbxVM76CfLEiRroZpl9OPMSf5CvNoaKP5NngQgi1DATg8NxRj2U8aB6BjJeMftHl3TJC/exec"; 

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then(s => vid.srcObject = s).catch(() => console.log("åˆ‡æ›ç›¸ç°¿æ¨¡å¼"));

    function render() {
        pBoxes.forEach((b, i) => b.innerHTML = queue[i] ? `<img src="${queue[i]}">` : "");
        saveBtn.style.display = queue.length > 0 ? 'block' : 'none';
        clearBtn.style.display = queue.length > 0 ? 'block' : 'none';
        camBtn.disabled = queue.length >= 3;
        camBtn.innerText = queue.length >= 3 ? "å·²é¸æ»¿ 3 å¼µ" : "ğŸ“· æ‹ç…§ / é¸å– (æœ€å¤š3å¼µ)";
    }

    camBtn.onclick = () => {
        if(confirm("ç¾å ´æ‹ç…§ï¼Ÿ(å–æ¶ˆå‰‡å¾ç›¸ç°¿é¸å–)")) {
            const c = document.getElementById('canvas');
            c.width = vid.videoWidth; c.height = vid.videoHeight;
            c.getContext('2d').drawImage(vid, 0, 0);
            queue.push(c.toDataURL('image/jpeg', 0.8));
            render();
        } else { fInput.click(); }
    };

    fInput.onchange = (e) => {
        Array.from(e.target.files).slice(0, 3 - queue.length).forEach(f => {
            const r = new FileReader();
            r.onload = (v) => { queue.push(v.target.result); render(); };
            r.readAsDataURL(f);
        });
    };

    clearBtn.onclick = () => { queue = []; render(); fInput.value = ""; };

    saveBtn.onclick = () => {
        const name = document.getElementById('p-name').value;
        if(!name) return alert("è«‹è¼¸å…¥ç”¢å“åç¨±");
        
        saveBtn.disabled = true;
        camBtn.disabled = true;
        loading.style.display = 'block';

        fetch(API, {
            method: "POST",
            body: JSON.stringify({
                images: queue.map(i => i.split(',')[1]),
                description: name,
                note: document.getElementById('p-note').value
            })
        })
        .then(res => res.json())
        .then(d => {
            if(d.status === "success") {
                alert(`âœ… è³‡æ–™åŒæ­¥å®Œæˆï¼\nè¨˜éŒ„å¸³è™Ÿï¼š${d.user}\næª”æ¡ˆå·²å­˜æ–¼ã€Œç”¢å“ç…§ç‰‡ä¸Šå‚³å€ã€æ—¥æœŸè³‡æ–™å¤¾ä¸­ã€‚`);
                location.reload();
            } else { 
                alert("å¤±æ•—ï¼š" + d.message); 
                saveBtn.disabled = false;
                camBtn.disabled = false;
            }
        })
        .catch(() => {
            alert("é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¢ºä¿æ‚¨åœ¨ Safari/Chrome ä¸­é–‹å•Ÿä¸¦å·²ç™»å…¥ Googleã€‚");
            saveBtn.disabled = false;
        })
        .finally(() => loading.style.display = 'none');
    };
</script>
</body>
</html>